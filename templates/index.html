<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“… ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºã‚·ã‚¹ãƒ†ãƒ  Dashboard</h1>

        <div class="nav-links">
            <a href="/users" class="btn-nav">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ² (User)</a>
            <a href="/products" class="btn-nav">ğŸ•’ ã‚·ãƒ•ãƒˆæ ç™»éŒ² (Product)</a>
            <a href="/orders" class="btn-nav">ğŸ™‹ å¸Œæœ›æå‡º (Order)</a>
        </div>

        <div class="summary-cards">
            <div class="card" style="border-top-color: #1abc9c;">
                <h3>ã‚¹ã‚¿ãƒƒãƒ•æ•°</h3>
                <p class="number">{{ total_users }}</p>
            </div>
            <div class="card" style="border-top-color: #3498db;">
                <h3>å‹Ÿé›†æ æ•°</h3>
                <p class="number">{{ total_products }}</p>
            </div>
            <div class="card" style="border-top-color: #e74c3c;">
                <h3>å¸Œæœ›æå‡ºæ•°</h3>
                <p class="number">{{ total_orders }}</p>
            </div>  
        </div>

        <div class="dashboard-grid">
            <div class="panel">
                <h2>ğŸ‘« ç”·å¥³æ¯”ç‡</h2>
                <div style="width: 80%; margin: 0 auto;">
                    <canvas id="genderChart"></canvas>
                </div>
                <script id="gender-labels-data" type="application/json">{{ gender_labels | tojson }}</script>
                <script id="gender-values-data" type="application/json">{{ gender_data | tojson }}</script>
            </div>

            <div class="panel">
                <h2>ğŸ† ä»Šæœˆã®æå‡ºæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <table class="styled-table">
                    <thead>
                        <tr><th>é †ä½</th><th>åå‰</th><th>å›æ•°</th></tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(rank=1, last_count=-1) %}
                        {% for item in user_ranking %}
                            {# å‰ã®äººã¨å›æ•°ãŒé•ã†å ´åˆã ã‘ã€é †ä½ã‚’ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—ç•ªå·(1, 2, 3...)ã«æ›´æ–° #}
                            {% if item.count != ns.last_count %}
                                {% set ns.rank = loop.index %}
                            {% endif %}
                            <tr>
                                <td>{{ ns.rank }}</td>
                                <td>{{ item.user.name }}</td>
                                <td>{{ item.count }} å›</td>
                            </tr>
                            {% set ns.last_count = item.count %}
                        {% else %}
                            <tr><td colspan="3">ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="panel" style="grid-column: 1 / -1;">
                <h2>ğŸ”¥ ä»Šæœˆã®äººæ°—ã‚·ãƒ•ãƒˆæ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <table class="styled-table">
                    <thead>
                        <tr><th>é †ä½</th><th>æ—¥æ™‚</th><th>å¸Œæœ›è€…</th></tr>
                    </thead>
                    <tbody>
                        {% set ns_p = namespace(rank=1, last_count=-1) %}
                        {% for item in product_ranking %}
                            {% if item.count != ns_p.last_count %}
                                {% set ns_p.rank = loop.index %}
                            {% endif %}
                            <tr>
                                <td>{{ ns_p.rank }}</td>
                                <td>{{ item.product.date }} / {{ item.product.name }}</td>
                                <td>{{ item.count }} äºº</td>
                            </tr>
                            {% set ns_p.last_count = item.count %}
                        {% else %}
                            <tr><td colspan="3">ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('genderChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const labels = JSON.parse(document.getElementById('gender-labels-data').textContent);
                const data = JSON.parse(document.getElementById('gender-values-data').textContent);

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            // è‰²ã®é †ç•ªã‚’åè»¢ï¼šèµ¤(ãƒ”ãƒ³ã‚¯)ã‚’å…ˆé ­ã€é’ã‚’2ç•ªç›®ã«ã™ã‚‹
                            backgroundColor: ['#36A2EB', '#FF6384']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom',
                                reverse: true
                             }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>